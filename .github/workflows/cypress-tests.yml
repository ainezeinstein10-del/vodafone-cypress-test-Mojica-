name: ci Tests

# Triggers the workflow on pushes and pull requests to your main branch
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  cypress-run:
    # Set a timeout for the entire job (e.g., 15 minutes) to prevent long-running or hung jobs
    timeout-minutes: 15
    # Running on Windows as requested to match the testing environment
    runs-on: windows-latest
    
    steps:
      # Check out your repository code
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # üì¶ Setup Node and Cache Dependencies
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20' # Specify a stable Node.js version
          
      - name: Restore node_modules cache
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        run: npm ci

      # ‚öôÔ∏è Build the application separately
      - name: Build Application
        run: npm run build # This assumes 'npm run build' is defined in your package.json

      # --- This single step runs Cypress using the built app and server ---
      - name: Cypress run
        uses: cypress-io/github-action@v6 
        with:
          # Build step is now handled above
          # build: npm run build
          
          # If your app needs a server running, uncomment and adjust the 'start' and 'wait-on' lines:
          start: npm start # or 'npm run dev' or whatever starts your application server
          # IMPORTANT: Double-check your package.json to ensure the 'start' script correctly serves your built app.

          # Explicitly running Chrome, which is necessary if you want to test outside of Electron
          browser: chrome 
          
          # If you have custom test commands, use the command property:
          # command: npm run test:ci 

      # üíæ Upload test results/artifacts for review (videos and screenshots of failed tests)
      - name: Upload artifacts (e.g., screenshots, reports)
        uses: actions/upload-artifact@v4
        if: always() # Run this step even if the previous one failed
        with:
          name: cypress-artifacts
          path: |
            cypress/videos
            cypress/screenshots
          retention-days: 7
